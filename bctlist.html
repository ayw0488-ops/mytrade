<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ ì•„ì¹´ì´ë¸Œ</title>
    <style>
        body { margin: 0; background-color: #121212; color: #e0e0e0; font-family: 'Pretendard', sans-serif; padding: 20px; display: flex; justify-content: center; }
        .list-container { width: 100%; max-width: 450px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h2 { color: #f3ba2f; margin: 0; font-size: 22px; }
        
        .header-btns { display: flex; gap: 8px; }

        .btn-action { background: #333; color: #fff; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; text-decoration: none; font-size: 13px; font-weight: bold; transition: 0.3s; }
        .btn-action:hover { background: #444; }
        
        .btn-write { background: transparent; color: #f3ba2f; border: 1px solid #f3ba2f; }
        .btn-write:hover { background: #f3ba2f; color: #000; }

        .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #1e1e1e; color: #888; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s; }
        .tab-btn.active { border-color: #f3ba2f; color: #f3ba2f; background: rgba(243, 186, 47, 0.1); }

        #logList { display: flex; flex-direction: column; gap: 12px; }
        .log-card { 
            background: #1e1e1e; border-radius: 15px; padding: 18px 20px; 
            border-left: 6px solid #444; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-decoration: none; color: inherit;
        }
        .log-card:active { transform: scale(0.97); }

        .log-info { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .log-dir { font-weight: 800; font-size: 17px; display: flex; align-items: center; flex-wrap: wrap; }
        .log-coin { color: #ffffff; font-weight: normal; margin-left: 6px; font-size: 15px; background: #333; padding: 2px 8px; border-radius: 6px; }
        
        .date-container { display: flex; flex-direction: column; gap: 3px; }
        .log-date { font-size: 13px; color: #bbb; display: flex; align-items: center; }
        .log-date.end-date { color: #f3ba2f; font-weight: 500; }
        .date-label { font-size: 10px; background: #333; padding: 1px 4px; border-radius: 3px; margin-right: 5px; color: #eee; }
        
        .log-stats { text-align: right; margin-left: 10px; }
        .log-status { font-size: 18px; font-weight: 900; display: block; margin-bottom: 4px; }
        .view-label { font-size: 11px; color: #666; display: block; }

        .empty-msg { text-align: center; color: #666; margin-top: 100px; font-size: 15px; }
        .loading-msg { text-align: center; color: #f3ba2f; margin-top: 100px; font-weight: bold; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <h2>Trade Archive</h2>
        <div class="header-btns">
            <a href="index.html?write=true" class="btn-action btn-write">ğŸ“’ ì¼ì§€ ì‘ì„±</a>
            <a href="index.html" class="btn-action">ê³„ì‚°ê¸°</a>
        </div>
    </div>

    <div class="filter-tabs">
        <button class="tab-btn active" onclick="window.loadLogs('all', this)">ì „ì²´</button>
        <button class="tab-btn" onclick="window.loadLogs('profit', this)">ìˆ˜ìµ</button>
        <button class="tab-btn" onclick="window.loadLogs('loss', this)">ì†ì‹¤</button>
    </div>

    <div id="logList">
        <div class="loading-msg">ì„œë²„ì—ì„œ ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script type="module">
    // Firebase SDK ë¡œë“œ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqbLB-bnniXhNj0XqtD0DlkWhk_2_0PkU",
        authDomain: "sxsx-75c73.firebaseapp.com",
        projectId: "sxsx-75c73",
        storageBucket: "sxsx-75c73.firebasestorage.app",
        messagingSenderId: "401139729279",
        appId: "1:401139729279:web:2a41b315873137bfeb104a",
        measurementId: "G-1200YV6S6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ë°ì´í„°ë¥¼ ë‹´ì•„ë‘˜ ì „ì—­ ë³€ìˆ˜
    let allLogs = [];

    window.loadLogs = async function(filter = 'all', btnElement = null) {
        const logList = document.getElementById('logList');
        
        if (btnElement) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
        }

        try {
            // ì²˜ìŒ ë¡œë“œí•  ë•Œë§Œ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´ (ì†ë„ í–¥ìƒ)
            if (allLogs.length === 0 || filter === 'refresh') {
                const q = query(collection(db, "tradeLogs"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                allLogs = [];
                querySnapshot.forEach((doc) => {
                    allLogs.push({ id: doc.id, ...doc.data() });
                });
            }

            if (allLogs.length === 0) {
                logList.innerHTML = '<div class="empty-msg">ê¸°ë¡ëœ ë§¤ë§¤ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ê³„ì‚°ê¸°ì—ì„œ ì¼ì§€ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
                return;
            }

            let filteredLogs = [...allLogs];
            if (filter === 'profit') {
                filteredLogs = allLogs.filter(log => log.status === "ì¢…ë£Œ" && parseFloat(log.actualProfit) > 0);
            } else if (filter === 'loss') {
                filteredLogs = allLogs.filter(log => log.status === "ì¢…ë£Œ" && parseFloat(log.actualProfit) < 0);
            }

            if (filteredLogs.length === 0) {
                logList.innerHTML = `<div class="empty-msg">${filter === 'profit' ? 'ìˆ˜ìµ' : 'ì†ì‹¤'} ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            logList.innerHTML = filteredLogs.map((log) => {
                const isLong = log.direction && log.direction.includes("ë¡±");
                const borderColor = isLong ? "#00c087" : "#ff4d4d";
                const dirColor = isLong ? "#00c087" : "#ff4d4d";

                let statusHtml = "";
                let dateContainerHtml = `<div class="log-date"><span class="date-label">ì‹œì‘</span>${log.date}</div>`;

                if (log.status === "ì§„í–‰ ì¤‘") {
                    statusHtml = `<span class="log-status" style="color: #aaa;">ì§„í–‰ ì¤‘</span>`;
                } else {
                    const profitVal = parseFloat(log.actualProfit);
                    const profitColor = profitVal >= 0 ? "#24a0ed" : "#ff4d4d";
                    const prefix = profitVal > 0 ? "+" : "";
                    statusHtml = `<span class="log-status" style="color: ${profitColor}">${prefix}${log.actualProfit}%</span>`;
                    
                    if (log.endDate) {
                        dateContainerHtml += `<div class="log-date end-date"><span class="date-label">ì¢…ë£Œ</span>${log.endDate}</div>`;
                    }
                }

                return `
                    <a href="bctdetail.html?id=${log.id}" class="log-card" style="border-left-color: ${borderColor}">
                        <div class="log-info">
                            <div class="log-dir" style="color: ${dirColor}">
                                ${log.direction} ${log.leverage}x
                                <span class="log-coin">${log.coinName || "Unknown"}</span>
                            </div>
                            <div class="date-container">
                                ${dateContainerHtml}
                            </div>
                        </div>
                        <div class="log-stats">
                            ${statusHtml}
                            <span class="view-label">ìƒì„¸ë³´ê¸° ></span>
                        </div>
                    </a>
                `;
            }).join('');
        } catch (error) {
            console.error(error);
            logList.innerHTML = '<div class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>Firebase ê·œì¹™ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</div>';
        }
    };

    // ì´ˆê¸° ë¡œë”©
    window.loadLogs('refresh');
</script>
</body>
</html>