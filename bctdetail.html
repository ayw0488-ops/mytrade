<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ ìƒì„¸ ì •ë³´</title>
    <style>
        body { margin: 0; background-color: #121212; color: #e0e0e0; font-family: 'Pretendard', sans-serif; padding: 20px; display: flex; justify-content: center; }
        .detail-container { width: 100%; max-width: 450px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h2 { color: #f3ba2f; margin: 0; font-size: 20px; }
        .btn-back { background: #333; color: #fff; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; text-decoration: none; font-size: 13px; font-weight: bold; }

        .info-card { background: #1e1e1e; border-radius: 20px; padding: 25px; border-top: 5px solid #f3ba2f; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .info-header { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .info-title { font-size: 24px; font-weight: 800; margin-bottom: 5px; }
        .info-date { font-size: 11px; color: #ffffff; margin-top: 4px; }

        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .data-item { background: #2b2b2b; padding: 15px; border-radius: 12px; }
        .data-label { font-size: 11px; color: #888; margin-bottom: 5px; display: block; }
        .data-value { font-size: 16px; font-weight: bold; color: #fff; }

        .action-section { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .action-title { font-size: 13px; font-weight: bold; color: #f3ba2f; margin-bottom: 10px; display: block; }
        .action-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .action-input { flex: 1; background: #000; border: 1px solid #444; padding: 8px; border-radius: 6px; color: #fff; font-size: 14px; }
        
        .btn-action { padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; font-size: 13px; }
        .btn-tp { background: #00c087; color: #fff; }
        .btn-add { background: #24a0ed; color: #fff; }

        .settle-section { background: #252525; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #444; }
        .btn-settle { background: #f3ba2f; color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .history-section { margin-bottom: 25px; }
        .history-label { font-size: 14px; font-weight: bold; color: #f3ba2f; margin-bottom: 10px; display: block; }
        .history-box { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .history-item { font-size: 13px; padding: 8px 0; border-bottom: 1px dashed #333; color: #ddd; line-height: 1.5; }
        .history-item:last-child { border-bottom: none; }
        .history-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; }
        .tag-tp { background: rgba(0, 192, 135, 0.2); color: #00c087; }
        .tag-add { background: rgba(36, 160, 237, 0.2); color: #24a0ed; }
        .tag-finish { background: rgba(243, 186, 47, 0.2); color: #f3ba2f; }

        .popup-btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-popup { flex: 1; background: #2b2b2b; color: #f3ba2f; border: 1px solid #f3ba2f; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #1e1e1e; width: 100%; max-width: 400px; padding: 20px; border-radius: 15px; border: 1px solid #333; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #aaa; cursor: pointer; background: none; border: none; }
        .modal-body { margin-top: 15px; color: #ccc; line-height: 1.6; }
        .modal-img { width: 100%; border-radius: 10px; margin-bottom: 15px; border: 1px solid #333; }
        
        .reason-text { background: #2b2b2b; padding: 15px; border-radius: 10px; white-space: pre-wrap; font-size: 14px; color: #ddd; min-height: 100px; border: 1px solid #444; width: 100%; box-sizing: border-box; font-family: inherit; margin-bottom: 15px; }
        .save-btn { background: #f3ba2f; color: #000; border: none; padding: 10px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .tp-list { display: flex; flex-direction: column; gap: 10px; }
        .tp-list-item { background: #2b2b2b; padding: 12px; border-radius: 10px; cursor: pointer; border-left: 4px solid #00c087; display: flex; justify-content: space-between; align-items: center; }
        .tp-list-item:hover { background: #333; }
        .tp-item-info { font-size: 14px; color: #fff; font-weight: bold; }
        .tp-item-time { font-size: 11px; color: #888; }

        .btn-delete-wrap { margin-top: 25px; text-align: right; }
        .btn-delete { background: none; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; }

        .duration-badge { font-size: 11px; background: rgba(243, 186, 47, 0.2); color: #f3ba2f; padding: 2px 8px; border-radius: 6px; margin-left: 10px; font-weight: bold; display: inline-block; vertical-align: middle; }
        
        .img-upload-box { background: #000; border: 1px dashed #444; border-radius: 10px; padding: 10px; text-align: center; margin-bottom: 15px; cursor: pointer; }
        .img-preview { width: 100%; border-radius: 8px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div class="detail-container">
    <div class="header">
        <h2>Trade Detail</h2>
        <a href="bctlist.html" class="btn-back">ëª©ë¡ìœ¼ë¡œ</a>
    </div>

    <div id="detailView" class="info-card">
        <div style="text-align:center; padding:50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="btn-delete-wrap">
        <button class="btn-delete" onclick="window.deleteCurrentLog()">í˜„ì¬ ì¼ì§€ ì˜êµ¬ ì‚­ì œ</button>
    </div>
</div>

<div id="infoModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <h3 id="modalTitle" style="color: #f3ba2f; margin-bottom: 15px;"></h3>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqbLB-bnniXhNj0XqtD0DlkWhk_2_0PkU",
        authDomain: "sxsx-75c73.firebaseapp.com",
        projectId: "sxsx-75c73",
        storageBucket: "sxsx-75c73.firebasestorage.app",
        messagingSenderId: "401139729279",
        appId: "1:401139729279:web:2a41b315873137bfeb104a",
        measurementId: "G-1200YV6S6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const urlParams = new URLSearchParams(window.location.search);
    const logId = urlParams.get('id');

    window.closeModal = function() { document.getElementById('infoModal').style.display = 'none'; }

    window.openEntryReason = async function() {
        const modal = document.getElementById('infoModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalTitle').innerText = "ì§„ì… ê·¼ê±°";
        const snap = await getDoc(doc(db, "tradeLogs", logId));
        const data = snap.data();
        const imgTag = data.img ? `<img src="${data.img}" class="modal-img">` : "";
        body.innerHTML = `${imgTag}<div class="reason-text">${data.reason || "ì‘ì„±ëœ ê·¼ê±°ê°€ ì—†ìŠµë‹ˆë‹¤."}</div>`;
        modal.style.display = 'flex';
    }

    window.openPartialReason = async function() {
        const modal = document.getElementById('infoModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalTitle').innerText = "ë°˜ìµ ê·¼ê±° ëª©ë¡";
        const snap = await getDoc(doc(db, "tradeLogs", logId));
        const data = snap.data();
        const history = data.tradeHistory || [];
        const tps = history.filter(h => h.type === 'ë°˜ìµ');
        if (tps.length === 0) {
            body.innerHTML = "<div style='text-align:center; padding:20px;'>ë°˜ìµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        } else {
            let listHtml = '<div class="tp-list">';
            tps.forEach((tp, index) => {
                listHtml += `<div class="tp-list-item" onclick="window.editTpDetail(${index})"><div class="tp-item-info">ê°€ê²©: ${tp.price.toLocaleString()}</div></div>`;
            });
            listHtml += '</div>';
            body.innerHTML = listHtml;
        }
        modal.style.display = 'flex';
    }

    window.editTpDetail = async function(idx) {
        const body = document.getElementById('modalBody');
        const snap = await getDoc(doc(db, "tradeLogs", logId));
        const data = snap.data();
        const history = data.tradeHistory || [];
        const tps = history.filter(h => h.type === 'ë°˜ìµ');
        const target = tps[idx];
        
        const existingImg = target.img ? `<img src="${target.img}" class="modal-img">` : `<img id="previewImg" class="img-preview">`;

        body.innerHTML = `
            <div style="margin-bottom:10px; font-weight:bold; color:#00c087;">ê°€ê²©: ${target.price.toLocaleString()}</div>
            <div class="img-upload-box" onclick="document.getElementById('fileInput').click()">
                ${existingImg}
                <span style="font-size:12px; color:#888;">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²¨ë¶€ (í´ë¦­)</span>
                <input type="file" id="fileInput" style="display:none;" accept="image/*" onchange="window.handleImgPreview(this)">
            </div>
            <textarea id="tempTpReason" class="reason-text" placeholder="ì´ ì‹œì ì˜ ë°˜ìµ ê·¼ê±°ë¥¼ ìƒì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”...">${target.detailReason || ""}</textarea>
            <button class="save-btn" id="saveBtn" onclick="window.saveTpDetail(${idx})">ê¸°ë¡ ì €ì¥</button>
            <button class="btn-back" style="width:100%; margin-top:10px;" onclick="window.openPartialReason()">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        `;
    }

    window.handleImgPreview = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewImg');
                if(preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    window.saveTpDetail = async function(idx) {
        const text = document.getElementById('tempTpReason').value;
        const fileInput = document.getElementById('fileInput');
        const saveBtn = document.getElementById('saveBtn');
        
        saveBtn.disabled = true;
        saveBtn.innerText = "ì—…ë¡œë“œ ë° ì €ì¥ ì¤‘...";

        const snap = await getDoc(doc(db, "tradeLogs", logId));
        const data = snap.data();
        let history = data.tradeHistory;
        
        let tpImgUrl = "";
        if (fileInput && fileInput.files[0]) {
            const file = fileInput.files[0];
            const storageRef = ref(storage, `tradeLogs/${logId}/partial_${idx}_${Date.now()}`);
            await uploadBytes(storageRef, file);
            tpImgUrl = await getDownloadURL(storageRef);
        }

        let tpCount = 0;
        for(let i=0; i<history.length; i++) {
            if(history[i].type === 'ë°˜ìµ') {
                if(tpCount === idx) { 
                    history[i].detailReason = text; 
                    if(tpImgUrl) history[i].img = tpImgUrl; 
                    break; 
                }
                tpCount++;
            }
        }
        await updateDoc(doc(db, "tradeLogs", logId), { tradeHistory: history });
        alert("ë°˜ìµ ê·¼ê±°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.openPartialReason();
    }

    window.openFinishReason = async function() {
        const modal = document.getElementById('infoModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalTitle').innerText = "ì™„ìµ ê·¼ê±°";
        const snap = await getDoc(doc(db, "tradeLogs", logId));
        const data = snap.data();
        
        if (data.status !== "ì¢…ë£Œ") {
            body.innerHTML = "<div style='text-align:center; padding:20px;'>ë§¤ë§¤ê°€ ì¢…ë£Œëœ í›„ì— ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>";
        } else {
            const existingImg = data.finishImg ? `<img src="${data.finishImg}" class="modal-img">` : `<img id="previewImgFinish" class="img-preview">`;
            
            body.innerHTML = `
                <div style="margin-bottom:10px; font-weight:bold; color:#f3ba2f;">ì¢…ë£Œ ì‹œê°„: ${data.endDate}</div>
                <div class="img-upload-box" onclick="document.getElementById('fileInputFinish').click()">
                    ${existingImg}
                    <span style="font-size:12px; color:#888;">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²¨ë¶€ (í´ë¦­)</span>
                    <input type="file" id="fileInputFinish" style="display:none;" accept="image/*" onchange="window.handleImgPreviewFinish(this)">
                </div>
                <textarea id="tempFinishReason" class="reason-text" placeholder="ìµœì¢… ë§¤ë„(ì™„ìµ) ê·¼ê±°ì™€ ë³µê¸°ë¥¼ ê¸°ë¡í•˜ì„¸ìš”...">${data.finishReason || ""}</textarea>
                <button class="save-btn" id="finishSaveBtn" onclick="window.saveFinishReason()">ì™„ìµ ê·¼ê±° ì €ì¥</button>
            `;
        }
        modal.style.display = 'flex';
    }

    window.handleImgPreviewFinish = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewImgFinish');
                if(preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    window.saveFinishReason = async function() {
        const text = document.getElementById('tempFinishReason').value;
        const fileInput = document.getElementById('fileInputFinish');
        const saveBtn = document.getElementById('finishSaveBtn');

        saveBtn.disabled = true;
        saveBtn.innerText = "ì—…ë¡œë“œ ë° ì €ì¥ ì¤‘...";

        let finishImgUrl = "";
        if (fileInput && fileInput.files[0]) {
            const file = fileInput.files[0];
            const storageRef = ref(storage, `tradeLogs/${logId}/finish_${Date.now()}`);
            await uploadBytes(storageRef, file);
            finishImgUrl = await getDownloadURL(storageRef);
        }

        const updateData = { finishReason: text };
        if(finishImgUrl) updateData.finishImg = finishImgUrl;

        await updateDoc(doc(db, "tradeLogs", logId), updateData);
        alert("ì™„ìµ ê·¼ê±°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeModal();
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;
        if (typeof dateStr === 'number') return dateStr;

        const isPM = dateStr.includes("ì˜¤í›„");
        const numbers = dateStr.match(/\d+/g).map(Number);
        
        if (!numbers || numbers.length < 5) return null;

        let year = numbers[0];
        let month = numbers[1] - 1;
        let day = numbers[2];
        let hour = numbers[3];
        let minute = numbers[4];
        let second = numbers[5] || 0;

        if (isPM && hour < 12) hour += 12;
        if (!isPM && hour === 12) hour = 0;

        return new Date(year, month, day, hour, minute, second).getTime();
    }

    function calculateTradeDuration(startTs, endStr) {
        if (!startTs || !endStr) return "";
        
        const startTime = parseDate(startTs);
        const endTime = parseDate(endStr);
        
        if (!startTime || !endTime) return "0ë¶„";
        
        const diffMs = endTime - startTime;
        if (diffMs < 0) return "0ë¶„";

        const totalMinutes = Math.floor(diffMs / 60000);
        const days = Math.floor(totalMinutes / (60 * 24));
        const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
        const mins = totalMinutes % 60;

        let result = "";
        if (days > 0) result += days + "ì¼ ";
        if (hours > 0) result += hours + "ì‹œê°„ ";
        if (mins > 0 || (days === 0 && hours === 0)) {
            result += mins + "ë¶„";
        }
        
        return result.trim();
    }

    async function loadDetail() {
        if (!logId) return;
        const detailView = document.getElementById('detailView');
        
        try {
            const docRef = doc(db, "tradeLogs", logId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) { detailView.innerHTML = '<div style="text-align:center; padding:50px;">ë°ì´í„° ì—†ìŒ</div>'; return; }

            const log = docSnap.data();
            const isLong = log.direction.includes("ë¡±");
            const dirColor = isLong ? "#00c087" : "#ff4d4d";

            let settleHtml = "";
            let actionHtml = "";
            let durationHtml = "";
            const displayVolume = log.status === "ì¢…ë£Œ" ? 0 : (log.currentVolume !== undefined ? log.currentVolume : 1);

            if (log.status === "ì¢…ë£Œ" && log.timestamp && log.endDate) {
                const duration = calculateTradeDuration(log.timestamp || log.date, log.endDate);
                if (duration) durationHtml = `<span class="duration-badge">â±ï¸ ${duration}</span>`;
            }

            if (log.status === "ì§„í–‰ ì¤‘") {
                actionHtml = `<div class="action-section"><span class="action-title">âœ‚ï¸ ë¶€ë¶„ ìµì ˆ (ë°˜ìµ)</span><div class="action-group"><input type="number" id="tpPrice" class="action-input" placeholder="ë°˜ìµ ê°€ê²©"><button class="btn-action btn-tp" onclick="window.partialTP()">ë°˜ìµ ì‹¤í–‰</button></div></div><div class="action-section"><span class="action-title">â• ì¶”ê°€ ë§¤ìˆ˜ (ì¶”ë§¤)</span><div class="action-group"><input type="number" id="addPrice" class="action-input" placeholder="ì¶”ë§¤ ê°€ê²©"><button class="btn-action btn-add" onclick="window.addPosition()">ì¶”ë§¤ ì‹¤í–‰</button></div></div>`;
                settleHtml = `<div class="settle-section"><span style="font-size:14px; font-weight:bold; color:#f3ba2f; display:block; margin-bottom:12px;">ğŸ ë§¤ë§¤ ì¢…ë£Œí•˜ê¸°</span><div style="display:flex; gap:10px;"><input type="number" id="sellPrice" style="flex:1; background:#121212; border:1px solid #444; padding:10px; border-radius:8px; color:#fff;" placeholder="ì¢…ë£Œ ê°€ê²©"><button class="btn-settle" onclick="window.finishTrade()">ì •ì‚°</button></div></div>`;
            } else {
                const profitVal = parseFloat(log.actualProfit);
                const profitColor = profitVal >= 0 ? "#24a0ed" : "#ff4d4d";
                settleHtml = `<div class="data-grid" style="margin-top:0;"><div class="data-item" style="border: 1px solid #444;"><span class="data-label">ì¢…ë£Œ ê°€ê²©(ë§¤ë„)</span><span class="data-value">${Number(log.sellPrice).toLocaleString()}</span></div><div class="data-item" style="border: 1px solid ${profitColor};"><span class="data-label">í†µí•© í™•ì • ìˆ˜ìµë¥ </span><span class="data-value" style="color: ${profitColor}">${profitVal > 0 ? "+" : ""}${log.actualProfit}%</span></div></div>`;
            }

            let historyHtml = "";
            if (log.tradeHistory && log.tradeHistory.length > 0) {
                historyHtml = `<div class="history-section"><span class="history-label">ğŸ”„ ë§¤ë§¤ íˆìŠ¤í† ë¦¬</span><div class="history-box">`;
                log.tradeHistory.forEach(item => {
                    let tagClass = item.type === 'ì¶”ë§¤' ? 'tag-add' : (item.type === 'ì™„ìµ' ? 'tag-finish' : 'tag-tp');
                    historyHtml += `<div class="history-item"><span class="history-tag ${tagClass}">${item.type}</span> <b>${item.price.toLocaleString()}</b> | ${item.msg}</div>`;
                });
                historyHtml += `</div></div>`;
            }

            detailView.innerHTML = `
                <div class="info-header">
                    <div class="info-title" style="color: ${dirColor}">
                        ${log.direction} ${log.leverage}x 
                        <span style="color:#fff; font-weight:normal; margin-left:10px;">${log.coinName || ""}</span>
                        ${durationHtml}
                    </div>
                    <div class="info-date">ì‘ì„±ì¼ì‹œ: ${log.date}</div>
                </div>
                ${actionHtml}
                ${settleHtml}
                <div class="data-grid">
                    <div class="data-item"><span class="data-label">í˜„ì¬ í‰ë‹¨ê°€</span><span class="data-value">${Number(log.entry).toLocaleString()}</span></div>
                    <div class="data-item"><span class="data-label">ì†ì ˆ ê°€ê²©</span><span class="data-value">${Number(log.stop).toLocaleString()}</span></div>
                    <div class="data-item"><span class="data-label">ì‚¬ìš© ë°°ìœ¨</span><span class="data-value">${log.leverage}x</span></div>
                    <div class="data-item"><span class="data-label">ë°˜ìµ í•©ì‚°</span><span class="data-value" style="color:#00c087">${log.partialProfit || 0}%</span></div>
                    <div class="data-item"><span class="data-label">ë‚¨ì€ ë¬¼ëŸ‰ ë¹„ì¤‘</span><span class="data-value" style="color:#f3ba2f">${(displayVolume * 100).toFixed(0)}%</span></div>
                </div>
                ${historyHtml}
                <div class="popup-btn-group">
                    <button class="btn-popup" onclick="openEntryReason()">ğŸ“ ì§„ì… ê·¼ê±°</button>
                    <button class="btn-popup" onclick="openPartialReason()">âœ‚ï¸ ë°˜ìµ ê·¼ê±°</button>
                    <button class="btn-popup" onclick="openFinishReason()">ğŸ ì™„ìµ ê·¼ê±°</button>
                </div>
            `;
        } catch (error) { console.error(error); }
    }

    window.partialTP = async function() {
        const tpPrice = parseFloat(document.getElementById('tpPrice').value);
        if (!tpPrice) { alert("ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
        const docRef = doc(db, "tradeLogs", logId);
        const docSnap = await getDoc(docRef);
        const log = docSnap.data();
        const entry = parseFloat(log.entry);
        const lev = parseFloat(log.leverage);
        const isLong = log.direction.includes("ë¡±");
        
        // [ìˆ˜ì •] ìˆ˜ìˆ˜ë£Œ ì°¨ê° ë¡œì§ ì ìš© (lev/10 ì°¨ê°)
        let roe = isLong ? ((tpPrice - entry) / entry) * 100 * lev : ((entry - tpPrice) / entry) * 100 * lev;
        roe = roe - (lev / 10);
        
        const currentVol = log.currentVolume !== undefined ? parseFloat(log.currentVolume) : 1.0;
        const partialVol = currentVol * 0.5;
        const partialEarned = roe * partialVol;
        const totalPartial = (parseFloat(log.partialProfit) || 0) + partialEarned;
        const newVol = currentVol - partialVol;

        await updateDoc(docRef, { 
            partialProfit: totalPartial.toFixed(2),
            currentVolume: newVol,
            tradeHistory: arrayUnion({
                type: 'ë°˜ìµ',
                price: tpPrice,
                msg: `ì‹¤í˜„ ìˆ˜ìµ: +${partialEarned.toFixed(2)}% (ë¬¼ëŸ‰ ${ (partialVol * 100).toFixed(1) }% ìµì ˆ)`,
                detailReason: ""
            })
        });
        alert(`ë°˜ìµ ì™„ë£Œ! ì´ë²ˆ ìµì ˆ ìˆ˜ìµ: ${partialEarned.toFixed(2)}%`);
        loadDetail();
    }

    window.addPosition = async function() {
        const addPrice = parseFloat(document.getElementById('addPrice').value);
        if (!addPrice) { alert("ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
        const docRef = doc(db, "tradeLogs", logId);
        const docSnap = await getDoc(docRef);
        const log = docSnap.data();
        const oldEntry = parseFloat(log.entry);
        const oldVol = log.currentVolume !== undefined ? parseFloat(log.currentVolume) : 1.0;
        const newEntry = (oldEntry + addPrice) / 2;
        const newVol = oldVol * 2; 
        await updateDoc(docRef, { entry: newEntry.toFixed(2), currentVolume: newVol, tradeHistory: arrayUnion({ type: 'ì¶”ë§¤', price: addPrice, msg: `í‰ë‹¨: ${newEntry.toFixed(2)} (ë¬¼ëŸ‰ 2ë°° ì¦ê°€)` }) });
        alert("ì¶”ë§¤ ì™„ë£Œ!");
        loadDetail();
    }

    window.finishTrade = async function() {
        const sellPrice = parseFloat(document.getElementById('sellPrice').value);
        if (!sellPrice) { alert("ë§¤ë„ ê°€ê²© ì…ë ¥!"); return; }
        const docRef = doc(db, "tradeLogs", logId);
        const docSnap = await getDoc(docRef);
        const log = docSnap.data();
        const entry = parseFloat(log.entry);
        const lev = parseFloat(log.leverage);
        const isLong = log.direction.includes("ë¡±");
        const partialAccumulated = parseFloat(log.partialProfit) || 0;
        const remainingVol = log.currentVolume !== undefined ? parseFloat(log.currentVolume) : 1.0;
        
        // [ìˆ˜ì •] ìˆ˜ìˆ˜ë£Œ ì°¨ê° ë¡œì§ ì ìš© (lev/10 ì°¨ê°)
        let roe = isLong ? ((sellPrice - entry) / entry) * 100 * lev : ((entry - sellPrice) / entry) * 100 * lev;
        roe = roe - (lev / 10);
        
        const finalRemainingProfit = roe * remainingVol;
        const totalProfit = partialAccumulated + finalRemainingProfit;

        await updateDoc(docRef, { 
            sellPrice: sellPrice, actualProfit: totalProfit.toFixed(2), status: "ì¢…ë£Œ", endDate: new Date().toLocaleString(), currentVolume: 0,
            tradeHistory: arrayUnion({ type: 'ì™„ìµ', price: sellPrice, msg: `ìµœì¢… ìˆ˜ìµ í•©ì‚°: ${totalProfit.toFixed(2)}%`, time: new Date().toLocaleTimeString() })
        });
        alert(`ë§¤ë§¤ ì¢…ë£Œ! ìµœì¢… í•©ì‚° ìˆ˜ìµë¥ : ${totalProfit.toFixed(2)}%`);
        loadDetail();
    }

    window.deleteCurrentLog = async function() { if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await deleteDoc(doc(db, "tradeLogs", logId)); location.href = 'bctlist.html'; } }

    window.onload = loadDetail;
</script>
</body>
</html>