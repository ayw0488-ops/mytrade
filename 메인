<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Master - Main</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; background-color: #121212; color: #e0e0e0; font-family: 'Pretendard', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: flex-start; overflow-x: hidden; }
        .main-container { width: 100%; max-width: 400px; padding: 20px; text-align: center; position: relative; }
        
        .top-header { display: flex; flex-direction: column; gap: 20px; margin-bottom: 25px; padding-top: 10px; }
        .logo-section { cursor: pointer; }
        .logo-section h1 { color: #f3ba2f; font-size: 28px; font-weight: 900; margin: 0; letter-spacing: -1px; }
        .logo-section p { color: #ffffff; margin-top: 5px; font-size: 13px; opacity: 0.9; }

        .balance-section { display: flex; align-items: center; justify-content: space-between; gap: 10px; width: 100%; }
        .btn-balance-action { background: #1e1e1e; color: #ffffff; border: 1px solid #333; width: 45px; height: 45px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; font-size: 14px; flex-shrink: 0; }
        .btn-balance-action:hover { border-color: #f3ba2f; color: #f3ba2f; }
        
        .balance-box { background: #1e1e1e; border: 1px solid #333; padding: 12px 15px; border-radius: 15px; flex-grow: 1; box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 0; position: relative; }
        .balance-label { font-size: 10px; color: #ffffff; margin-bottom: 3px; display: block; opacity: 0.8; }
        .balance-amount { font-size: 18px; font-weight: 900; color: #f3ba2f; white-space: nowrap; }
        
        .balance-diff { font-size: 12px; font-weight: bold; margin-top: 6px; display: block; min-height: 15px; }
        .start-date-label { font-size: 13px; font-weight: bold; color: #f3ba2f; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); white-space: nowrap; }

        .mood-section { margin-bottom: 20px; text-align: left; background: #1e1e1e; padding: 15px; border-radius: 15px; border: 1px solid #333; }
        .mood-title { font-size: 12px; color: #f3ba2f; font-weight: bold; margin-bottom: 10px; display: block; }
        .mood-input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .mood-input { flex-grow: 1; background: #121212; border: 1px solid #444; border-radius: 8px; padding: 8px; color: #fff; font-size: 13px; }
        .mood-btn { background: #f3ba2f; color: #000; border: none; border-radius: 8px; padding: 0 12px; font-weight: bold; cursor: pointer; }
        
        /* [ìˆ˜ì •] í¼ì¹˜ê¸° ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .latest-mood-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; cursor: pointer; }
        .mood-list { display: none; max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .mood-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted #333; font-size: 12px; }
        .mood-time { color: #888; font-size: 10px; margin-right: 8px; white-space: nowrap; }
        .mood-text { flex-grow: 1; color: #e0e0e0; }
        .mood-del { color: #ff4d4d; background: none; border: none; cursor: pointer; font-weight: bold; padding: 0 5px; }
        .expand-arrow { font-size: 12px; color: #f3ba2f; transition: 0.3s; }
        .active .expand-arrow { transform: rotate(180deg); }

        .chart-container { background: #1e1e1e; border: 1px solid #333; border-radius: 20px; padding: 15px; margin-bottom: 25px; height: 200px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .menu-group { display: flex; flex-direction: column; gap: 15px; }
        .menu-btn { display: flex; align-items: center; justify-content: center; padding: 20px; border-radius: 15px; text-decoration: none; font-size: 18px; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-write { background-color: #f3ba2f; color: #000; }
        .btn-write:hover { background-color: #ffca42; transform: translateY(-3px); }
        .btn-list { background-color: #1e1e1e; color: #f3ba2f; border: 1px solid #f3ba2f; }
        .btn-list:hover { background-color: #2b2b2b; transform: translateY(-3px); }
        .btn-chart { background-color: #2b2b2b; color: #ffffff; border: 1px solid #444; }
        .btn-chart:hover { background-color: #383838; transform: translateY(-3px); border-color: #f3ba2f; }
        .btn-icon { margin-right: 10px; font-size: 22px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #1e1e1e; width: 100%; max-width: 350px; padding: 25px; border-radius: 20px; border: 1px solid #444; max-height: 80vh; overflow-y: auto; }
        .btn-finish { width: 100%; padding: 12px; background: none; border: 1px solid #ff4d4d; color: #ff4d4d; border-radius: 10px; margin-top: 10px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .close-btn { width: 100%; padding: 12px; background: #333; color: #fff; border: none; border-radius: 10px; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="top-header">
        <div class="logo-section">
            <h1>TRADE LOG</h1>
            <p>ê¸°ë¡ì€ ë°°ì‹ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="balance-section">
            <button class="btn-balance-action" onclick="location.href='trade_history.html'">ê¸°ë¡</button>
            <div class="balance-box">
                <span class="start-date-label" id="startDateDisplay">í”„ë¡œì íŠ¸ ì‹œì‘ ì „</span>
                <span class="balance-label">TOTAL ASSETS (KRW)</span>
                <span class="balance-amount" id="currentBalance">0 ì›</span>
                <span class="balance-diff" id="balanceDiff"></span>
            </div>
            <button class="btn-balance-action" id="adminUpdateBtn" onclick="location.href='balance_manager.html'">âœï¸</button>
        </div>
    </div>

    <div class="mood-section">
        <span class="mood-title">&lt;ì§€ê¸ˆ ë‚´ ì‹¬ì •ì€...&gt;</span>
        <div class="mood-input-group">
            <input type="text" id="moodInput" class="mood-input" placeholder="í˜„ì¬ ì‹¬ì •ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button class="mood-btn" onclick="saveMood()">ì €ì¥</button>
        </div>
        
        <div class="latest-mood-container" onclick="toggleMoodList()">
            <div id="latestMoodDisplay" style="font-size: 13px; color: #fff; text-align: left;">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <span class="expand-arrow" id="moodArrow">â–¼</span>
        </div>
        
        <div id="moodList" class="mood-list"></div>
    </div>

    <div class="chart-container">
        <canvas id="assetChart"></canvas>
    </div>

    <div class="menu-group">
        <a href="calculator.html?write=true" class="menu-btn btn-write"><span class="btn-icon">ğŸ“’</span> ë§¤ë§¤ì¼ì§€ ì‘ì„±</a>
        <a href="bctlist.html" class="menu-btn btn-list"><span class="btn-icon">ğŸ“‚</span> ë§¤ë§¤ì¼ì§€ ëª©ë¡</a>
        <a href="chartboard.html" class="menu-btn btn-chart"><span class="btn-icon">ğŸ“ˆ</span> ì°¨íŠ¸ ë¶„ì„</a>
    </div>
</div>

<div class="modal" id="historyModal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#f3ba2f; text-align:center;">Project Finish</h3>
        <p style="font-size:13px; color:#ffffff; text-align:center; line-height:1.5;">í˜„ì¬ í”„ë¡œì íŠ¸ë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ë§ˆê° ì‹œ ë©”ì¸ í™”ë©´ì˜ ì”ì•¡ì€ 0ì›ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
        <button class="btn-finish" onclick="finishProject()">ğŸš© í”„ë¡œì íŠ¸ ë§ˆê° ë° ì´ˆê¸°í™”</button>
        <button class="close-btn" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, deleteDoc, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqbLB-bnniXhNj0XqtD0DlkWhk_2_0PkU",
        authDomain: "sxsx-75c73.firebaseapp.com",
        projectId: "sxsx-75c73",
        storageBucket: "sxsx-75c73.firebasestorage.app",
        messagingSenderId: "401139729279",
        appId: "1:401139729279:web:2a41b315873137bfeb104a",
        measurementId: "G-1200YV6S6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myChart = null; 

    // ëª©ë¡ í† ê¸€ ê¸°ëŠ¥
    window.toggleMoodList = function() {
        const list = document.getElementById('moodList');
        const arrow = document.getElementById('moodArrow');
        const container = document.querySelector('.latest-mood-container');
        if (list.style.display === 'block') {
            list.style.display = 'none';
            container.classList.remove('active');
        } else {
            list.style.display = 'block';
            container.classList.add('active');
        }
    }

    // ë©”ëª¨ ì €ì¥
    window.saveMood = async function() {
        const input = document.getElementById('moodInput');
        const text = input.value;
        if(!text) return;
        try {
            await addDoc(collection(db, "moodDiary"), {
                content: text,
                timestamp: Date.now(),
                dateStr: new Date().toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
            });
            input.value = "";
            fetchMoods();
        } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
    }

    // ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸° (ìµœì‹  1ê°œ ë³„ë„ ì¶”ì¶œ ë¡œì§)
    async function fetchMoods() {
        const q = query(collection(db, "moodDiary"), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        let html = "";
        let index = 0;
        
        if (snap.empty) {
            document.getElementById('latestMoodDisplay').innerText = "ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.";
            document.getElementById('moodList').innerHTML = "";
            return;
        }

        snap.forEach(s => {
            const data = s.data();
            // ìµœì‹  1ê°œëŠ” ë©”ì¸ì— í‘œì‹œ
            if (index === 0) {
                document.getElementById('latestMoodDisplay').innerText = data.content;
            }
            // ì „ì²´ ëª©ë¡ ìƒì„±
            html += `
                <div class="mood-item">
                    <span class="mood-time">${data.dateStr}</span>
                    <span class="mood-text">${data.content}</span>
                    <button class="mood-del" onclick="deleteMood('${s.id}')">Ã—</button>
                </div>`;
            index++;
        });
        document.getElementById('moodList').innerHTML = html;
    }

    window.deleteMood = async function(id) {
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        await deleteDoc(doc(db, "moodDiary", id));
        fetchMoods();
    }

    async function fetchLatestBalance() {
        const qAll = query(collection(db, "balanceHistory"), orderBy("timestamp", "asc"));
        const snapAll = await getDocs(qAll);
        const activeDocs = snapAll.docs.filter(d => d.data().status === "ì§„í–‰ì¤‘");
        const balanceEl = document.getElementById('currentBalance');
        const diffEl = document.getElementById('balanceDiff');
        const dateEl = document.getElementById('startDateDisplay');

        if (activeDocs.length === 0) {
            balanceEl.innerText = "0 ì›";
            diffEl.innerText = "";
            dateEl.innerText = "í”„ë¡œì íŠ¸ ì‹œì‘ ì „";
            updateChart([], []); 
            return;
        }

        const latestData = activeDocs[activeDocs.length - 1].data();
        balanceEl.innerText = Number(latestData.amount).toLocaleString() + " ì›";

        const firstActive = activeDocs[0].data();
        if(firstActive.date) {
            const p = firstActive.date.split('. ');
            dateEl.innerText = `ì‹œì‘ì¼: ${p[0]}.${p[1]}.${p[2]}`;
        }

        if (activeDocs.length > 1) {
            const currentVal = activeDocs[activeDocs.length - 1].data().amount;
            const prevVal = activeDocs[activeDocs.length - 2].data().amount;
            const diff = currentVal - prevVal;
            if (diff > 0) {
                diffEl.innerText = "+" + diff.toLocaleString() + " ì›";
                diffEl.style.color = "#00c087";
            } else if (diff < 0) {
                diffEl.innerText = diff.toLocaleString() + " ì›";
                diffEl.style.color = "#ff4d4d";
            } else {
                diffEl.innerText = "0 ì›";
                diffEl.style.color = "#888";
            }
        } else { diffEl.innerText = ""; }

        const labels = activeDocs.map(d => d.data().date.split('. ')[2] + 'ì¼');
        const amounts = activeDocs.map(d => d.data().amount);
        updateChart(labels, amounts);
    }

    function updateChart(labels, data) {
        const ctx = document.getElementById('assetChart').getContext('2d');
        if (myChart) { myChart.destroy(); } 
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Asset',
                    data: data,
                    borderColor: '#f3ba2f',
                    backgroundColor: 'rgba(243, 186, 47, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: '#f3ba2f'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#ffffff', font: { size: 10 } } },
                    y: { 
                        grid: { color: '#444' },
                        ticks: { color: '#ffffff', font: { size: 10 }, callback: (v) => v.toLocaleString() },
                        beginAtZero: false 
                    }
                }
            }
        });
    }

    window.finishProject = async function() {
        const qAll = query(collection(db, "balanceHistory"), orderBy("timestamp", "asc"));
        const snap = await getDocs(qAll);
        const activeDocs = snap.docs.filter(d => d.data().status === "ì§„í–‰ì¤‘");
        if (activeDocs.length === 0) { alert("ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        const startData = activeDocs[0].data();
        const lastData = activeDocs[activeDocs.length - 1].data();
        const totalProfit = lastData.amount - startData.amount;
        const profitRate = startData.amount === 0 ? 0 : ((totalProfit / startData.amount) * 100).toFixed(2);
        const days = Math.floor((lastData.timestamp - startData.timestamp) / (1000 * 60 * 60 * 24)) + 1;
        if(!confirm(`[ë§ˆê° í™•ì¸]\nì´ ìˆ˜ìµ: ${totalProfit.toLocaleString()}ì›\në§ˆê° ì‹œ ë©”ì¸ ì”ì•¡ì€ 0ì›ìœ¼ë¡œ ë¦¬ì…‹ë©ë‹ˆë‹¤.`)) return;
        try {
            const batch = writeBatch(db);
            activeDocs.forEach((d) => { batch.update(doc(db, "balanceHistory", d.id), { status: "ë§ˆê°ì™„ë£Œ" }); });
            const summaryRef = doc(collection(db, "balanceHistory"));
            batch.set(summaryRef, {
                amount: lastData.amount, date: new Date().toLocaleString(), timestamp: Date.now() + 100, status: "ë§ˆê°",
                summary: { startAmount: startData.amount, profit: totalProfit, rate: profitRate, period: days, startDate: startData.date }
            });
            await batch.commit();
            alert("ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ì”ì•¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } catch (e) { alert("ë§ˆê° ì‹¤íŒ¨!"); }
    }

    document.querySelector('.logo-section').onclick = () => {
        document.getElementById('historyModal').style.display = 'flex';
    };
    window.closeModal = () => document.getElementById('historyModal').style.display = 'none';

    fetchLatestBalance();
    fetchMoods();
</script>
</body>
</html>
