<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade History - ì„±ì í‘œ ë³´ê´€í•¨</title>
    <style>
        body { margin: 0; background-color: #0a0a0a; color: #fff; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 400px; padding: 20px; text-align: center; }
        
        h2 { color: #f3ba2f; margin-bottom: 25px; font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .report-card { 
            background: #161616; border: 1px solid #333; border-radius: 12px; 
            margin-bottom: 12px; cursor: pointer; transition: 0.2s; overflow: hidden;
        }
        .report-card:hover { border-color: #f3ba2f; }
        
        .card-header { 
            padding: 12px 15px; display: flex; align-items: center; justify-content: space-between;
        }

        /* ì‚­ì œ ë²„íŠ¼ ì™¼ìª½ ë°°ì¹˜ */
        .btn-del { background: none; border: none; color: #ff4d4d; cursor: pointer; font-size: 18px; padding: 0 10px 0 0; font-weight: bold; }
        
        .header-main-info { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; margin-right: 10px; }
        .report-date { font-size: 11px; color: #888; font-weight: bold; }
        .report-profit { font-size: 14px; font-weight: 900; }

        /* í™”ì‚´í‘œ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .arrow-icon { font-size: 14px; color: #666; transition: 0.3s; transform: rotate(0deg); }
        .active .arrow-icon { transform: rotate(180deg); color: #f3ba2f; }

        .card-detail { 
            display: none; background: #1f1f1f; padding: 15px; border-top: 1px solid #333;
            text-align: left; font-size: 12px; line-height: 1.8; color: #ccc;
        }
        .detail-item { display: flex; justify-content: space-between; border-bottom: 1px dotted #444; padding: 4px 0; }
        .detail-val { color: #f3ba2f; font-weight: bold; }

        .nav-link { display: block; margin-top: 30px; color: #666; text-decoration: none; font-size: 13px; font-weight: bold; }
        .nav-link:hover { color: #f3ba2f; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ† TRADE REPORTS</h2>
    <div id="reportList">
        <p style="color:#444;">ì„±ì í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    <a href="index.html" class="nav-link">â† ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqbLB-bnniXhNj0XqtD0DlkWhk_2_0PkU",
        authDomain: "sxsx-75c73.firebaseapp.com",
        projectId: "sxsx-75c73",
        storageBucket: "sxsx-75c73.firebasestorage.app",
        messagingSenderId: "401139729279",
        appId: "1:401139729279:web:2a41b315873137bfeb104a",
        measurementId: "G-1200YV6S6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.toggleCard = function(el) {
        const detail = el.querySelector('.card-detail');
        const isVisible = detail.style.display === 'block';
        detail.style.display = isVisible ? 'none' : 'block';
        el.classList.toggle('active', !isVisible);
    }

    window.deleteReport = async function(e, id) {
        e.stopPropagation();
        if(!confirm("ì´ ì„±ì í‘œë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            await deleteDoc(doc(db, "balanceHistory", id));
            location.reload();
        } catch (err) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
    }

    async function loadReports() {
        const listDiv = document.getElementById('reportList');
        try {
            const q = query(collection(db, "balanceHistory"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            
            let html = "";
            const reports = snap.docs.filter(d => d.data().status === "ë§ˆê°");

            if (reports.length === 0) {
                html = "<p style='color:#666;'>ë§ˆê°ëœ ì„±ì í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            } else {
                reports.forEach(s => {
                    const data = s.data();
                    const id = s.id;
                    
                    // ë°ì´í„° í•„ë“œëª… í™•ì¸ ë° ì•ˆì „í•œ í´ë°±(0) ì²˜ë¦¬
                    const summary = data.summary || {};
                    const profit = summary.profit || 0;
                    const rate = summary.rate || "0.00";
                    // ì´ë¯¸ì§€ì—ì„œ ë³´ì´ì§€ ì•Šë˜ ì‹œì‘ ê¸ˆì•¡ í•„ë“œ ìˆ˜ì •
                    const startAmt = summary.startAmount || summary.start || 0; 
                    const period = summary.period || 0;
                    const finalAmt = data.amount || 0;
                    
                    const color = profit >= 0 ? "#00c087" : "#ff4d4d";
                    const sign = profit >= 0 ? "+" : "";

                    html += `
                        <div class="report-card" onclick="toggleCard(this)">
                            <div class="card-header">
                                <button class="btn-del" onclick="deleteReport(event, '${id}')">&times;</button>
                                <div class="header-main-info">
                                    <span class="report-date">${data.date ? data.date.split(' ì˜¤í›„')[0].split(' ì˜¤ì „')[0] : 'ë‚ ì§œ ì—†ìŒ'}</span>
                                    <span class="report-profit" style="color:${color}">${sign}${Number(profit).toLocaleString()}ì› (${rate}%)</span>
                                </div>
                                <span class="arrow-icon">â–¼</span>
                            </div>
                            <div class="card-detail">
                                <div class="detail-item"><span>ì‹œì‘ ì›ê¸ˆ</span><span class="detail-val">${Number(startAmt).toLocaleString()}ì›</span></div>
                                <div class="detail-item"><span>ìµœì¢… ì”ì•¡</span><span class="detail-val">${Number(finalAmt).toLocaleString()}ì›</span></div>
                                <div class="detail-item"><span>ì´ ìˆ˜ìµ</span><span class="detail-val" style="color:${color}">${sign}${Number(profit).toLocaleString()}ì›</span></div>
                                <div class="detail-item"><span>ìˆ˜ìµë¥ </span><span class="detail-val" style="color:${color}">${rate}%</span></div>
                                <div class="detail-item"><span>ë§¤ë§¤ ê¸°ê°„</span><span class="detail-val">${period}ì¼</span></div>
                            </div>
                        </div>
                    `;
                });
            }
            listDiv.innerHTML = html;
        } catch (error) {
            listDiv.innerHTML = "<p style='color:#ff4d4d;'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
    }

    loadReports();
</script>
</body>
</html>