<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ ìƒì„¸ ì •ë³´</title>
    <style>
        body { margin: 0; background-color: #121212; color: #e0e0e0; font-family: 'Pretendard', sans-serif; padding: 20px; display: flex; justify-content: center; }
        .detail-container { width: 100%; max-width: 450px; }
        
        /* í—¤ë” ì˜ì—­ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h2 { color: #f3ba2f; margin: 0; font-size: 20px; }
        .btn-back { background: #333; color: #fff; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; text-decoration: none; font-size: 13px; font-weight: bold; }

        /* ìƒì„¸ ì •ë³´ ì¹´ë“œ */
        .info-card { background: #1e1e1e; border-radius: 20px; padding: 25px; border-top: 5px solid #f3ba2f; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .info-header { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .info-title { font-size: 24px; font-weight: 800; margin-bottom: 5px; }
        
        /* [ìˆ˜ì •] ë‚ ì§œ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼: í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        .info-date { font-size: 11px; color: #ffffff; margin-top: 4px; }

        /* [ì¶”ê°€] ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .info-image { width: 100%; border-radius: 12px; margin-bottom: 25px; border: 1px solid #333; display: block; }

        /* ë°ì´í„° ê·¸ë¦¬ë“œ */
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .data-item { background: #2b2b2b; padding: 15px; border-radius: 12px; }
        .data-label { font-size: 11px; color: #888; margin-bottom: 5px; display: block; }
        .data-value { font-size: 16px; font-weight: bold; color: #fff; }

        /* ë§¤ë§¤ ì¢…ë£Œ ì…ë ¥ ì˜ì—­ */
        .settle-section { background: #252525; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #444; }
        .settle-label { font-size: 14px; font-weight: bold; color: #f3ba2f; margin-bottom: 12px; display: block; }
        .settle-input-group { display: flex; gap: 10px; }
        .settle-input { flex: 1; background: #121212; border: 1px solid #444; padding: 10px; border-radius: 8px; color: #fff; font-size: 16px; }
        .btn-settle { background: #f3ba2f; color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* ì§„ì… ê·¼ê±° ì˜ì—­ */
        .reason-section { margin-top: 10px; }
        .reason-label { font-size: 14px; font-weight: bold; color: #f3ba2f; margin-bottom: 10px; display: block; }
        .reason-content { background: #2b2b2b; padding: 20px; border-radius: 12px; font-size: 15px; line-height: 1.7; color: #ccc; white-space: pre-wrap; min-height: 150px; }

        /* ì‚­ì œ ë²„íŠ¼ */
        .btn-delete-wrap { margin-top: 25px; text-align: right; }
        .btn-delete { background: none; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.3s; }
        .btn-delete:hover { background: #ff4d4d; color: #fff; }
    </style>
</head>
<body>

<div class="detail-container">
    <div class="header">
        <h2>Trade Detail</h2>
        <a href="bctlist.html" class="btn-back">ëª©ë¡ìœ¼ë¡œ</a>
    </div>

    <div id="detailView" class="info-card">
        <div style="text-align:center; padding:50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="btn-delete-wrap">
        <button class="btn-delete" onclick="window.deleteCurrentLog()">í˜„ì¬ ì¼ì§€ ì˜êµ¬ ì‚­ì œ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqbLB-bnniXhNj0XqtD0DlkWhk_2_0PkU",
        authDomain: "sxsx-75c73.firebaseapp.com",
        projectId: "sxsx-75c73",
        storageBucket: "sxsx-75c73.firebasestorage.app",
        messagingSenderId: "401139729279",
        appId: "1:401139729279:web:2a41b315873137bfeb104a",
        measurementId: "G-1200YV6S6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const logId = urlParams.get('id');

    // ì„œë²„ì—ì„œ ìƒì„¸ ë°ì´í„° ë¡œë“œ
    async function loadDetail() {
        if (!logId) return;
        const detailView = document.getElementById('detailView');
        
        try {
            const docRef = doc(db, "tradeLogs", logId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                detailView.innerHTML = '<div style="text-align:center; padding:50px;">ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const log = docSnap.data();
            const isLong = log.direction.includes("ë¡±");
            const dirColor = isLong ? "#00c087" : "#ff4d4d";

            let settleHtml = "";
            let dateHtml = `ì‘ì„±ì¼ì‹œ: ${log.date}`;

            if (log.status === "ì§„í–‰ ì¤‘") {
                settleHtml = `
                    <div class="settle-section">
                        <span class="settle-label">ğŸ ë§¤ë§¤ ì¢…ë£Œí•˜ê¸°</span>
                        <div class="settle-input-group">
                            <input type="number" id="sellPrice" class="settle-input" placeholder="ì¢…ë£Œ ê°€ê²©(ë§¤ë„ê°€) ì…ë ¥">
                            <button class="btn-settle" onclick="window.finishTrade()">ì •ì‚°</button>
                        </div>
                    </div>
                `;
            } else {
                const profitVal = parseFloat(log.actualProfit);
                const profitColor = profitVal >= 0 ? "#24a0ed" : "#ff4d4d";
                
                if (log.endDate) {
                    dateHtml += ` | í¬ì§€ì…˜ ì¢…ë£Œ: ${log.endDate}`;
                }

                settleHtml = `
                    <div class="data-grid" style="margin-top:0;">
                        <div class="data-item" style="border: 1px solid #444;">
                            <span class="data-label">ì¢…ë£Œ ê°€ê²©(ë§¤ë„)</span>
                            <span class="data-value">${Number(log.sellPrice).toLocaleString()}</span>
                        </div>
                        <div class="data-item" style="border: 1px solid ${profitColor};">
                            <span class="data-label">í™•ì • ìˆ˜ìµë¥ </span>
                            <span class="data-value" style="color: ${profitColor}">${profitVal > 0 ? "+" : ""}${log.actualProfit}%</span>
                        </div>
                    </div>
                `;
            }

            const imgHtml = log.img ? `<img src="${log.img}" class="info-image">` : "";

            detailView.innerHTML = `
                <div class="info-header">
                    <div class="info-title" style="color: ${dirColor}">
                        ${log.direction} ${log.leverage}x 
                        <span style="color: #fff; font-weight: normal; margin-left: 10px;">${log.coinName || ""}</span>
                    </div>
                    <div class="info-date">${dateHtml}</div>
                </div>
                
                ${settleHtml}

                ${imgHtml}

                <div class="data-grid">
                    <div class="data-item"><span class="data-label">ì§„ì… ê°€ê²©</span><span class="data-value">${Number(log.entry).toLocaleString()}</span></div>
                    <div class="data-item"><span class="data-label">ì†ì ˆ ê°€ê²©</span><span class="data-value">${Number(log.stop).toLocaleString()}</span></div>
                    <div class="data-item"><span class="data-label">ì‚¬ìš© ë°°ìœ¨</span><span class="data-value">${log.leverage}x</span></div>
                </div>

                <div class="reason-section">
                    <span class="reason-label">ì§„ì… ê·¼ê±° (Trade Reason)</span>
                    <div class="reason-content">${log.reason || "ì‘ì„±ëœ ê·¼ê±°ê°€ ì—†ìŠµë‹ˆë‹¤."}</div>
                </div>
            `;
        } catch (error) {
            console.error(error);
            detailView.innerHTML = '<div style="text-align:center; padding:50px;">ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ì„œë²„ ì •ì‚° ì—…ë°ì´íŠ¸
    window.finishTrade = async function() {
        const sellPrice = parseFloat(document.getElementById('sellPrice').value);
        if (!sellPrice) { alert("ë§¤ë„ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

        const docRef = doc(db, "tradeLogs", logId);
        const docSnap = await getDoc(docRef);
        const log = docSnap.data();

        const entry = parseFloat(log.entry);
        const lev = parseFloat(log.leverage);
        const isLong = log.direction.includes("ë¡±");
        
        let profitPercent;
        if (isLong) {
            profitPercent = ((sellPrice - entry) / entry) * 100 * lev;
        } else {
            profitPercent = ((entry - sellPrice) / entry) * 100 * lev;
        }

        try {
            await updateDoc(docRef, {
                sellPrice: sellPrice,
                actualProfit: profitPercent.toFixed(2),
                status: "ì¢…ë£Œ",
                endDate: new Date().toLocaleString()
            });
            alert(`ë§¤ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ìˆ˜ìµë¥ : ${profitPercent.toFixed(2)}%`);
            loadDetail();
        } catch (error) {
            alert("ì •ì‚° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ì„œë²„ ë°ì´í„° ì‚­ì œ
    window.deleteCurrentLog = async function() {
        if (confirm("ì´ ë§¤ë§¤ê¸°ë¡ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            try {
                await deleteDoc(doc(db, "tradeLogs", logId));
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.href = 'bctlist.html';
            } catch (error) {
                alert("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    }

    window.onload = loadDetail;
</script>

</body>
</html>