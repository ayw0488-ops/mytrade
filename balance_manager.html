<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Manager - ë…ë¦½ ê´€ë¦¬ ë„êµ¬</title>
    <style>
        body { margin: 0; background-color: #0a0a0a; color: #fff; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .manager-container { width: 100%; max-width: 400px; padding: 20px; text-align: center; }
        
        .status-card { background: #161616; border: 1px solid #333; padding: 25px; border-radius: 20px; margin-bottom: 25px; position: relative; }
        .session-tag { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #f3ba2f; color: #000; padding: 3px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .amount-display { font-size: 28px; font-weight: 900; color: #f3ba2f; margin: 10px 0; display: block; }
        .diff-display { font-size: 14px; font-weight: bold; min-height: 20px; }

        .input-group { background: #1c1c1c; padding: 20px; border-radius: 20px; border: 1px solid #333; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; border-radius: 10px; color: #fff; font-size: 16px; box-sizing: border-box; text-align: center; }
        .btn-update { width: 100%; background: #f3ba2f; color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }

        .history-section { background: #161616; border-radius: 20px; padding: 15px; border: 1px solid #333; max-height: 350px; overflow-y: auto; }
        .history-title { font-size: 14px; color: #f3ba2f; margin-bottom: 15px; font-weight: bold; text-align: left; padding-left: 5px; }
        .history-item { padding: 12px; border-bottom: 1px solid #222; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .history-info { display: flex; flex-direction: column; }
        .history-date { font-size: 11px; color: #666; margin-bottom: 2px; }
        .history-amt { font-size: 15px; font-weight: bold; color: #e0e0e0; }
        .history-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
        .status-active { background: #1a3a2a; color: #00c087; }
        .status-closed { background: #333; color: #888; }
        
        .summary-box { background: #222; padding: 10px; border-radius: 8px; border-left: 3px solid #f3ba2f; margin-top: 8px; font-size: 12px; color: #bbb; width: 100%; box-sizing: border-box; }
        .btn-finish { width: 100%; background: none; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 12px; border-radius: 10px; margin-top: 20px; font-weight: bold; cursor: pointer; }
        .nav-link { display: block; margin-top: 20px; color: #888; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>

<div class="manager-container">
    <div class="status-card">
        <span class="session-tag" id="sessionLabel">í”„ë¡œì íŠ¸ ëŒ€ê¸°ì¤‘</span>
        <span style="font-size: 12px; color: #888;">CURRENT BALANCE</span>
        <span class="amount-display" id="currVal">0 ì›</span>
        <div class="diff-display" id="diffVal"></div>
    </div>

    <div class="input-group">
        <input type="number" id="balanceInput" placeholder="ìƒˆë¡œìš´ ì”ì•¡ ì…ë ¥ (ì›)">
        <button class="btn-update" onclick="updateAmount()">ì”ì•¡ ê¸°ë¡í•˜ê¸°</button>
    </div>

    <div class="history-section">
        <div class="history-title">ë‚´ ì”ì•¡ ê¸°ë¡ ëª©ë¡</div>
        <div id="historyList">
            <p style="color:#666; font-size:13px; text-align: center;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <button class="btn-finish" onclick="finishProject()">ğŸš© ì´ í”„ë¡œì íŠ¸ ë§ˆê° (ë¦¬í¬íŠ¸ ìƒì„±)</button>
    <a href="index.html" class="nav-link">â† ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, deleteDoc, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqbLB-bnniXhNj0XqtD0DlkWhk_2_0PkU",
        authDomain: "sxsx-75c73.firebaseapp.com",
        projectId: "sxsx-75c73",
        storageBucket: "sxsx-75c73.firebasestorage.app",
        messagingSenderId: "401139729279",
        appId: "1:401139729279:web:2a41b315873137bfeb104a",
        measurementId: "G-1200YV6S6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadHistory() {
        // [ìˆ˜ì •] ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì¿¼ë¦¬ë¥¼ ë‹¨ìˆœí™”í•˜ì—¬ ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²˜ë¦¬
        const q = query(collection(db, "balanceHistory"), orderBy("timestamp", "desc"), limit(30));
        const snap = await getDocs(q);
        let html = "";
        
        snap.forEach(s => {
            const d = s.data();
            const isM = d.status === "ë§ˆê°";
            const isActive = d.status === "ì§„í–‰ì¤‘";
            
            html += `
                <div class="history-card-wrapper" style="margin-bottom: 10px; border-bottom: 1px solid #222; padding-bottom: 10px;">
                    <div class="history-item" style="border:none;">
                        <div class="history-info">
                            <span class="history-date">${d.date}</span>
                            <span class="history-amt">${Number(d.amount).toLocaleString()} ì›</span>
                        </div>
                        <div>
                            ${isM ? '<span class="history-status" style="background:#ff4d4d; color:#fff;">ë§ˆê°ë¦¬í¬íŠ¸</span>' : ''}
                            ${isActive ? '<span class="history-status status-active">ì§„í–‰ì¤‘</span>' : '<span class="history-status status-closed">ì™„ë£Œ</span>'}
                        </div>
                    </div>
                    ${isM ? `<div class="summary-box">ğŸ† <b>í”„ë¡œì íŠ¸ ì„±ì </b><br>ìˆ˜ìµ: ${d.summary.profit.toLocaleString()}ì› (${d.summary.rate}%)</div>` : ''}
                </div>
            `;
        });
        const historyListEl = document.getElementById('historyList');
        if(historyListEl) historyListEl.innerHTML = html || "<p style='color:#666; text-align:center;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    }

    async function refreshData() {
        // [ìˆ˜ì •] ë³µí•© ìƒ‰ì¸ ì—†ì´ë„ ì‘ë™í•˜ë„ë¡ ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ "ì§„í–‰ì¤‘"ë§Œ í•„í„°ë§
        const qAll = query(collection(db, "balanceHistory"), orderBy("timestamp", "desc"));
        const snap = await getDocs(qAll);
        const allDocs = snap.docs;
        const docs = allDocs.filter(d => d.data().status === "ì§„í–‰ì¤‘");

        const currValEl = document.getElementById('currVal');
        const diffValEl = document.getElementById('diffVal');
        const labelEl = document.getElementById('sessionLabel');

        if (docs.length > 0) {
            const latest = docs[0].data();
            currValEl.innerText = Number(latest.amount).toLocaleString() + " ì›";
            const start = docs[docs.length - 1].data();
            labelEl.innerText = "ì§„í–‰ì¤‘ (ì‹œì‘: " + (start.date ? start.date.split(' ')[0] : 'ë¯¸ì •') + ")";

            if (docs.length > 1) {
                const diff = latest.amount - docs[1].data().amount;
                diffValEl.innerText = (diff > 0 ? "+" : "") + diff.toLocaleString() + " ì›";
                diffValEl.style.color = diff > 0 ? "#00c087" : "#ff4d4d";
            } else { diffValEl.innerText = ""; }
        } else {
            currValEl.innerText = "0 ì›";
            labelEl.innerText = "ìƒˆ í”„ë¡œì íŠ¸ ì‹œì‘ ê°€ëŠ¥";
        }
        await loadHistory();
    }

    window.updateAmount = async function() {
        const amtInput = document.getElementById('balanceInput');
        const amt = amtInput.value;
        if (!amt) return;
        try {
            await addDoc(collection(db, "balanceHistory"), {
                amount: parseFloat(amt),
                date: new Date().toLocaleString(),
                timestamp: Date.now(),
                status: "ì§„í–‰ì¤‘"
            });
            amtInput.value = "";
            await refreshData();
        } catch (e) { 
            console.error(e);
            alert("ê¸°ë¡ ì‹¤íŒ¨: Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”."); 
        }
    }

    window.finishProject = async function() {
        const qAll = query(collection(db, "balanceHistory"), orderBy("timestamp", "asc"));
        const snap = await getDocs(qAll);
        const activeDocs = snap.docs.filter(d => d.data().status === "ì§„í–‰ì¤‘");
        
        if (activeDocs.length === 0) return;

        const start = activeDocs[0].data();
        const end = activeDocs[activeDocs.length - 1].data();
        const profit = end.amount - start.amount;
        const rate = start.amount === 0 ? 0 : ((profit / start.amount) * 100).toFixed(2);

        if (!confirm(`ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ìˆ˜ìµ: ${profit.toLocaleString()}ì› (${rate}%)`)) return;

        try {
            const batch = writeBatch(db);
            activeDocs.forEach(d => batch.update(doc(db, "balanceHistory", d.id), { status: "ì¢…ë£Œ" }));
            
            const summaryRef = doc(collection(db, "balanceHistory"));
            batch.set(summaryRef, {
                amount: end.amount, date: new Date().toLocaleString(), timestamp: Date.now() + 5, status: "ë§ˆê°",
                summary: { start: start.amount, profit, rate }
            });
            await batch.commit();
            await refreshData();
        } catch (e) {
            console.error(e);
            alert("ë§ˆê° ì‹¤íŒ¨");
        }
    }

    refreshData();
</script>
</body>
</html>